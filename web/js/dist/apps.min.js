function loadTemplates(a){Ember.$.ajax({async:!0,type:"GET",url:"templates/dist/templates.js"}).then(function(){a.advanceReadiness()})}window.ENV=window.ENV||{},console.log("setting up authentication..."),window.ENV["simple-auth"]={authorizer:"authorizer:custom",routeAfterAuthentication:"wrapper",routeIfAlreadyAuthenticated:"wrapper",applicationRootUrl:"login"},Ember.Application.initializer({name:"authentication",before:"simple-auth",initialize:function(a,b){a.register("authenticator:custom",App.GeofinAuthenticator),a.register("authorizer:custom",App.GeofinAuthorizer)}}),App=Ember.Application.create({isAdmin:function(){return"true"===window.localStorage.getItem("isAdmin")},username:function(){return window.localStorage.getItem("username")},token:function(){return window.localStorage.getItem("token")},saveToken:function(a,b,c){window.localStorage.setItem("token",a),window.localStorage.setItem("isAdmin",b),window.localStorage.setItem("username",c),Ember.$.ajaxSetup({headers:{"x-access-token":a}})},updateToken:function(a,b){window.localStorage.setItem("token",a),Ember.$.ajaxSetup({headers:{"x-access-token":a}}),Ember.run(function(){b()})}}),App.GRoute=Ember.Route.extend(SimpleAuth.AuthenticatedRouteMixin),App.deferReadiness(),App.Router.map(function(){this.route("login"),this.resource("wrapper",{path:"/"},function(){this.resource("main",{path:"/:selection_url"},function(){this.resource("builder",{path:"query-builder"}),this.resource("global"),this.resource("region",{path:"region"}),this.resource("city"),this.resource("branch"),this.resource("subject"),this.resource("morelikethis",{path:"similar-countries"}),this.resource("profiler",{path:"profiler"}),this.resource("aps",{path:"associated-locations"}),this.resource("transfers"),this.resource("test")})})}),config.TESTING?App.advanceReadiness():loadTemplates(App),App.Router.reopen({rootURL:config.ROOT_URL}),App.ApplicationRoute=Ember.Route.extend(SimpleAuth.ApplicationRouteMixin),App.ApplicationController=Ember.Controller.extend({needs:["main"],drop_counter:0,username:void 0,isAdmin:function(){return App.isAdmin()}.property(),use_query:!1,user_query:config.DEFAULT_ACE_CONTENT,user_query_did_change:function(){this.get("use_query")?this.set("controllers.main.state.user_query",this.get("user_query")):this.set("controllers.main.state.user_query",void 0)}.observes("user_query","use_query"),actions:{accountSettings:function(){var a=this;Ember.Widgets.ModalComponent.popup({primary:{targetObject:a,headerText:"Account Settings",confirmText:"Done",cancelText:void 0,use_query:a.get("use_query"),exact_geoname:a.get("controllers.main.state.exact_geoname"),ts_resolution:a.get("controllers.main.state.ts_resolution"),ts_resolution_options:a.get("controllers.main.ts_resolution_options"),accuracies:a.get("controllers.main.state.accuracies"),classNames:["account-settings-modal"],contentViewClass:App.AccountModalView},computed:{isAdmin:function(){return App.isAdmin()}.property(),username:function(){return App.username()}.property(),ts_resolution_did_change:function(){a.set("controllers.main.state.ts_resolution",this.get("ts_resolution"))}.observes("ts_resolution"),exact_geoname_did_change:function(){a.set("controllers.main.state.exact_geoname",this.get("exact_geoname"))}.observes("exact_geoname")}})}}}),App.AccountModalView=Ember.View.extend({templateName:"account",didInsertElement:function(){var a=this.get("controller"),b=_.keys(a.get("accuracies")),c=6;_.map(b,function(b){$("#"+b+"-slider").slider({min:1,max:"subject"===b?"branch"===b?c-4:c-1:c,value:a.get("accuracies."+b)||c,step:1,change:function(d,e){e.value<c?a.set("accuracies."+b,e.value):a.set("accuracies."+b,0)}})})}}),App.WrapperView=Ember.View.extend(),App.WrapperRoute=App.GRoute.extend({beforeModel:function(a){"wrapper.index"==a.targetName&&this.transitionTo("main",config.DEFAULT_PATH)}}),App.Serializable=Ember.Mixin.create({serialize:function(){var a={};for(var b in $.extend(!0,{},this))"isInstance"!==b&&"isDestroyed"!==b&&"isDestroying"!==b&&"concatenatedProperties"!==b&&"function"!=typeof this[b]&&(a[b]=this[b]);return a}}),App.Helper=Ember.Object.extend(),App.Helper.reopenClass({flattenJSON:function(a){function b(a,d){if(Object(a)!==a)c[d]=a;else if(Array.isArray(a)){for(var e=0,f=a.length;f>e;e++)b(a[e],d+"["+e+"]");0===f&&(c[d]=[])}else{var g=!0;for(var h in a)g=!1,b(a[h],d?d+"."+h:h);g&&d&&(c[d]={})}}var c={};return b(a,""),c},dateToYMD:function(a){var b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate();return""+b+"-"+(10>c?"0"+c:c)+"-"+(10>d?"0"+d:d)},locus_property:function(a){return void 0!==a.borders_selection&&(a=a.borders_selection),"world"===a.value?"ISO2":"state"===a.value?"STUSPS":void 0},nested_sortBy:function(a,b){var c=this;return a=_.sortBy(a,function(a){return parseInt(a.values[b-1].value,10)}),_.map(a,function(a){a.children&&(a.children=c.nested_sortBy(a.children,b))}),a},nested_reverse:function(a,b){var c=this;return a.reverse(),_.map(a,function(a){a.children&&(a.children=c.nested_reverse(a.children,b))}),a},smart_sortBy:function(a,b){var c;if(b.match("\\.")){b+="";var d=b.split(".");c=_.sortBy(a,function(a){var b=a;return _.map(d,function(a){b=b[a]}),b})}else c=_.sortBy(a,function(a){return a[b]});return c},capitalize:function(a){return a.replace(/^./g,a.charAt(0).toUpperCase())},iso2name:function(a,b,c){var d=this,e=[];return c&&(e=_.filter(c[b.value],function(c){return c.properties[d.locus_property(b)]===a})),e.length>0?e[0].properties.NAME:"No Region"},clean_class:function(a){return a.replace(/\./g,"_").replace(/-/g,"_")},make_place_list:function(a,b){var c=this;return _.map(a,function(a){return{name:a.properties.NAME,locii:[{name:a.properties.NAME,locus_id:a.properties[c.locus_property(b)]}]}})},download:function(a,b,c){var d=document,e=d.createElement("a");if(c=c||"application/octet-stream",navigator.msSaveBlob)return navigator.msSaveBlob(new Blob([a],{type:c}),b);if("download"in e)return e.href="data:"+c+","+encodeURIComponent(a),e.setAttribute("download",b),e.innerHTML="downloading...",d.body.appendChild(e),setTimeout(function(){e.click(),d.body.removeChild(e)},66),!0;var f=d.createElement("iframe");return d.body.appendChild(f),f.src="data:"+c+","+encodeURIComponent(a),setTimeout(function(){d.body.removeChild(f)},333),!0}}),App.GeofinAuthenticator=SimpleAuth.Authenticators.Base.extend({tokenEndpoint:(config.TESTING?config.TESTING_DOMAIN:config.NODE_PATH)+"login",verifyEndpoint:(config.TESTING?config.TESTING_DOMAIN:config.NODE_PATH)+"check_token",restore:function(a){var b=this;return Ember.isEmpty(a.token)||config.TESTING||Ember.$.ajaxSetup({headers:{"x-access-token":a.token}}),new Ember.RSVP.Promise(function(c,d){Ember.isEmpty(a.token)?Ember.run(this,d):Ember.$.ajax({url:b.verifyEndpoint,type:"GET",contentType:"application/json",dataType:"json",success:function(b){Ember.run(function(){b.authenticated?c(a):d()})},error:function(a){403==a.status?(console.log("$$$ auth: access denied on restore -- the token must be outdated"),Ember.run(this,d)):alert("There was an error reaching the server. (Unrecognized certificate or bad connection most likely.)")}})})},authenticate:function(a){var b=this;return console.log("$$$ auth: trying to authenticate..."),new Ember.RSVP.Promise(function(c,d){var e=JSON.stringify({username:a.identification,password:a.password});Ember.$.ajax({url:b.tokenEndpoint,type:"POST",data:e,contentType:"application/json",dataType:"json"}).then(function(a){console.log("$$$ auth: response -- ",a),App.saveToken(a.token,a.isAdmin,a.username),Ember.run(function(){c({token:a.token,username:a.username,isAdmin:a.isAdmin})})},function(a,b,c){console.log("$$$ auth: rejecting...",c," ",b," ",JSON.stringify(a)),Ember.run(this,d,a.responseText)})})},invalidate:function(){var a=this;return window.localStorage.setItem("token",void 0),window.localStorage.setItem("username",void 0),window.localStorage.setItem("isAdmin",void 0),new Ember.RSVP.Promise(function(b){Ember.$.ajax({url:a.tokenEndpoint,type:"DELETE"}).always(function(){Ember.run(this,b)})})}}),App.GeofinAuthorizer=SimpleAuth.Authorizers.Base.extend({authorize:function(a,b){this.get("session.isAuthenticated")&&!Ember.isEmpty(this.get("session.token"))&&a.setRequestHeader("Authorization","Token: "+this.get("session.token"))}}),App.LoginRoute=Ember.Route.extend({setupController:function(a,b){this.get("session.isAuthenticated")?(console.log("$$$ auth: already authenticated..."),this.transitionTo("wrapper")):a.set("errorMessage",null)}}),App.LoginController=Ember.Controller.extend(SimpleAuth.LoginControllerMixin,{authenticator:"authenticator:custom",show_login:!0,actions:{authenticate:function(){console.log("$$$ auth: start");var a=this;this._super().then(null,function(b){console.log("$$$ auth: finish w/ message:",b),a.set("errorMessage",b)})}}}),App.LoginView=Ember.View.extend({willInsertElement:function(){"gated"===config.AUTHENTICATION.STRATEGY&&(console.log("$$$ auth: -- gated authentication enabled --- "),this.set("controller.show_login",!1),this.get("controller").send("authenticate"))},didInsertElement:function(){$("#input-username").focus()}}),App.FormToggleView=Ember.View.extend({tagName:"",templateName:"form-toggle",didInsertElement:function(){this.set("form_type_label",this.get("f.form_type_label")),this.get("f.toggled")||$("#"+this.get("f.form_type")).addClass("inactive-form-type")}}),App.FormTypeModalView=Ember.View.extend({templateName:"form-type-modal",didInsertElement:function(){var a=this.get("controller.content");_.map(a.locus_actors,function(a){a.toggled||$("#"+a.id).addClass("hidden-subfield")}),_.map(a.amount_types,function(a){a.toggled||$("#"+a.id).addClass("hidden-subfield")})}}),App.Select2View=Ember.Select.extend({prompt:"Please select...",didInsertElement:function(){Ember.run.scheduleOnce("afterRender",this,"processChildElements")},processChildElements:function(){this.$().select2({})},_underlyingSelectionDidChange:Ember.observer(function(){this.$().select2("val",this.$().val().toString())},"selection.@each"),willDestroyElement:function(){this.$().select2("destroy")}}),App.ToggleSwitch=Ember.View.extend({classNames:["toggle-switch"],templateName:"toggle-switch",init:function(){return this._super.apply(this,arguments),this.on("change",this,this._updateElementValue)},checkBoxId:function(){return"checker-"+this.get("elementId")}.property(),_updateElementValue:function(){return this.set("checked",this.$("input").prop("checked"))}}),Ember.Widgets.ModalComponent.reopenClass({popup:function(a){var b,c;return a||(a={}),this.hideAll(),c=a.rootElement||this.rootElement,a.computed&&this.reopen(a.computed),b=this.create(a.primary),b.get("targetObject.container")&&b.set("container",b.get("targetObject.container")),b.appendTo(c),b}}),App.BaseClient=Ember.Object.extend({node_path:void 0,form_types:void 0,loading:0,increment_loading:function(){var a=this;Ember.run(function(){a.set("loading",a.get("loading")+1)})},decrement_loading:function(){var a=this;Ember.run(function(){a.set("loading",a.get("loading")-1)})},errorMessage:"no errors right now",authentication_warning:function(){alert("Your authentication credentials have expired! Please log out (using the x in the upper right hand corner) and log back in.  Restarting the browser may be necessary in rare conditions...")},unauthorized_warning:function(){alert("You are attempting to access a part of the app that you are not authorized to access!")},server_error_warning:function(){alert("Internal server error! No data returned.\n\nError:"+this.get("errorMessage.responseText"))},validate_state:function(a){return a?a.start_date&&a.end_date&&void 0!==a.ts_resolution:!1},fetch:function(a,b,c,d){d||this.validate_state(a)?this._fetch(b,c):console.log("`fetch` not validated!")},_fetch:function(a,b){var c=this;c.increment_loading(),Ember.$.ajax({type:"POST",contentType:"application/json",dataType:"json",url:this.get("node_path")+a.path,data:JSON.stringify(a),success:function(d){c.decrement_loading(),d.new_token?(console.log("$$$ received new token",d.new_token),App.updateToken(d.new_token,function(){c.fetch(void 0,a,b,!0)})):Ember.run(this,b,d)},error:function(a){c.decrement_loading(),c.set("errorMessage",a),401==a.status?Ember.run.debounce(c,"unauthorized_warning",1e3,!1):403==a.status?Ember.run.debounce(c,"authentication_warning",1e3,!1):500==a.status&&Ember.run.debounce(c,"server_error_warning",1e3,!1)}})},gf_get:function(a){var b=this;b.increment_loading();var c=Ember.$.getJSON(a);return new Ember.RSVP.Promise(function(d,e){c.then(function(c){b.decrement_loading(),c.new_token?(console.log("$$$ received new token",c.new_token),App.updateToken(c.new_token,function(){b.gf_get(a).then(function(a){Ember.run(this,d,a)})})):Ember.run(this,d,c)},function(a){b.decrement_loading(),500==a.status&&Ember.run.debounce(b,"server_error_warning",1e3,!1)})})}}),App.MetricHandler=Ember.Object.extend({}),App.MetricHandler.reopenClass({_from_parameterization:function(a){a.field.match("^gfloc")&&alert("this query is probably unsupported! (Specifically, the nesting has not been accounted for)");var b={};return b[a.name]={filter:{bool:{must:[{terms:{"gfloc.locus_actor":a.locus_actors}},{terms:{"gfloc.type":a.form_types}}]}},aggs:{step_out_avg:{reverse_nested:{},aggs:{inner:{}}}}},b[a.name].aggs.step_out_avg.aggs.inner[a.statistic]={field:a.field},b},metric_aggs:function(a){var b;return _.contains(["explicit","special"],a.pre_def.type)?b=a.pre_def:"parameterized"==a.pre_def.type&&(b={type:"explicit",content:{step_in_inner:{nested:{path:"gfloc"},aggs:App.MetricHandler._from_parameterization(a.pre_def.content)}}}),b}}),App.NormHandler=Ember.Object.extend(),App.NormHandler.reopenClass({make_norm:function(a,b){var c=a.norm_type.pre_def;c.fix_time||(c.state.start_date=a.start_date,c.state.end_date=a.end_date),c.fix_forms||(c.state.form_types=a.form_types),c.fix_metric||(c.state.metric_type=a.metric_type),c.state.selected=a.selected,c.state.selected_bounds=a.selected_bounds,c.state.ts_resolution.value=a.ts_resolution.value,b(c.state)}}),App.GFClient=App.BaseClient.extend({run_fetch_form_types:function(){return this.gf_get(this.get("node_path")+"fetch_form_types")},run_fetch_form_type_fields:function(a,b){this.fetch(void 0,{path:"fetch_form_type_fields",form_types:a},function(a){Ember.run(this,b,a)},!0)},make_norm:function(a,b,c,d){var e;return App.NormHandler.make_norm(a,function(a){e={value:a.metric_type.value,def:{type:"realtime",query:b(d,a,c)}}}),e},rf_params_query:function(a,b,c){var d={path:a,metric_type:b.metric_type.value||void 0,start_date:b.start_date,end_date:b.end_date,form_types:b.form_types,borders_selection:b.borders_selection.value||void 0,user_query:b.user_query,exact_geoname:b.exact_geoname,norm:void 0,accuracy:Math.pow(10,b.accuracies.global)-1};if("fetch_global"!==a?(d=_.extend(d,{selected:b.selected,client_aggs:c}),"fetch_locus"!==a&&(d=_.extend(d,{selected_bounds:b.selected_bounds}))):"fetch_dissection"!==a&&(d=_.extend(d,{size:100})),"fetch_global"===a){var e=b.get?b.get("active_columns"):b.active_columns;d=_.extend(d,{additional_metric_types:_.pluck(e,"value"),client_aggs:_.map(e,App.MetricHandler.metric_aggs)})}if("fetch_dissection"===a){var f={form_type_field:config.FIELDS.SUBJECT_ID,n_dissection:100};d=_.extend(d,f)}return d},rf_client_aggs:function(a,b){var c,d;if("fetch_locus"!==a&&(c={type:"special",content:{id:"type_agg"},aggs:App.MetricHandler.metric_aggs(b.metric_type)}),d={type:"special",content:{id:"date_agg"},params:{interval:b.ts_resolution.value},aggs:App.MetricHandler.metric_aggs(b.metric_type)},"fetch_locus"===a)return[d,App.MetricHandler.metric_aggs(b.metric_type)];var e=[c,d,App.MetricHandler.metric_aggs(b.metric_type)],f=_.chain(e).map(JSON.stringify).uniq().map(JSON.parse).value();return f},rf_params:function(a,b,c){var d="fetch_global"===a?[]:c.rf_client_aggs(a,b),e=c.rf_params_query(a,b,d);return b.norm_type.pre_def&&(e.norm=c.make_norm(b,c.rf_params,c,a)),e},run_fetch_global:function(a,b){var c=this;if(void 0===a.form_types|0===a.active_columns.length)return!1;var d=c.rf_params("fetch_global",a,c);this.fetch(a,d,function(a){b({data:a})})},run_fetch_locus:function(a,b){var c=this;if(a.selected){var d=c.rf_params("fetch_locus",a,c);this.fetch(a,d,function(a){b({data:a,eub:a.eub})})}else b({data:void 0,eub:void 0})},run_fetch_populated_places:function(a,b){var c=this;if(a.selected||a.selected_bounds){var d=c.rf_params("fetch_populated_places",a,c);this.fetch(a,d,function(a){b({data:a.data,eub:a.eub})})}else b({data:void 0,eub:void 0})},run_fetch_branches:function(a,b){var c=this;if(a.selected||a.selected_bounds){var d=c.rf_params("fetch_branches",a,c);this.fetch(a,d,function(a){b({data:a.data,eub:a.eub})})}else b({data:void 0,eub:void 0})},run_fetch_subjects:function(a,b,c){var d=this;if(a.selected||a.selected_bounds){var e=d.rf_params("fetch_dissection",a,this);c&&_.extend(e,{subject_query:c}),this.fetch(a,e,function(a){b({data:a.data,eub:a.eub})})}else b({data:void 0,eub:void 0})},run_fetch_subject_geo:function(a,b,c){if(c.get("single_subject_key")){var d={path:"fetch_subject_geo",start_date:a.start_date,end_date:a.end_date,form_types:a.form_types,user_query:a.user_query,exact_geoname:a.exact_geoname,single_subject:c.get("single_subject_key"),augmentation_type:void 0,size:100};this.fetch(a,d,function(a){b({data:a.data,eub:void 0})})}else b({data:void 0,eub:void 0})},run_fetch_reports:function(a,b,c){console.log("++ state.selected",a.selected);var d=_.extend({path:"fetch_reports",data_type:b.data_type,selected:a.selected,selected_bounds:a.selected_bounds,start_date:a.start_date,end_date:a.end_date,form_types:a.form_types,borders_selection:a.borders_selection.value,user_query:a.user_query,exact_geoname:a.exact_geoname,n_reports:b.n_reports||config.NUM_OF_REPORTS,sortBy:b.sortBy,reverse:b.reverse,page:b.page},b);this.fetch(a,d,function(a){c(a)})},get_report:function(a,b,c){this.gf_get(this.get("node_path")+"get_report?type="+a+"&id="+b).then(function(a){c(a)})},get_borders:function(a){this.gf_get(this.get("node_path")+"get_borders").then(function(b){config.USE_JSON_SHAPEFILES||(console.log("parsing topojson"),_.map(_.keys(b),function(a){b[a]=omnivore.topojson.parse(b[a])})),console.log("got borders",b),a(b)})},get_locus_name:function(a,b,c,d){var e=this;d?c(e._get_locus_name(a,b,d)):this.get_borders(function(d){c(e._get_locus_name(a,b,d))})},_get_locus_name:function(a,b,c){return _.map(a.split(","),function(a){return{name:App.Helper.iso2name(a,b.get("borders_selection"),c),locus_id:a}})},get_mapping:function(a){this.gf_get(this.get("node_path")+"get_mapping").then(function(b){a(b)})}}),App.Client=App.GFClient.extend(),App.Client.reopenClass({make:function(a){return new Ember.RSVP.Promise(function(b,c){var d=App.Client.create({node_path:a});d.run_fetch_form_types().then(function(a){d.set("form_types",a.form_types),Ember.run(this,b,d)})},function(a){reject(a)})}}),App.Styler=Ember.Object.extend({targetObject:void 0,thresholds:void 0,legend:function(){var a=this.get("targetObject.name");return App.Legend.make(this,this.get("targetObject.map"),{title:a})}.property(),threshold_type:"val",threshold_transform:"log",n_steps:config.DEFAULT_N_STEPS,colors:["white","gray","black"],opacity:.3,style_did_change:function(){this.get("targetObject").refresh()}.observes("colors.@each","n_steps","opacity"),color_pallette:function(){var a=this.get("n_steps"),b=new Rainbow;return b.setNumberRange(0,a-1),b.setSpectrumByArray(this.get("colors")),_.map(_.range(0,a),function(a){return"#"+b.colourAt(a)})}.property("colors","n_steps"),get_threshold_index:function(a){var b=this.get("thresholds");return _.indexOf(b,_.max(_.filter(b,function(b){return a>=b})))},get_radius:function(a){var b=10;return(this.get_threshold_index(a)+1)/this.get("n_steps")*b},get_color:function(a){var b=this.get("color_pallette");return b[this.get_threshold_index(a)]},get_opacity:function(){return this.get("opacity")},set_legend:function(){var a=this.get("thresholds"),b=this.get("color_pallette");this.get("legend").change_html(a,b),this.get("legend").show()},clear_legend:function(){this.get("legend").hide()}}),App.Styler.reopenClass({compute_thresholds:function(a,b,c,d){return _.isEmpty(_.max(a))!==!1&&_.uniq(a).length>1?(console.log("compute_thresholds :: trying"),"rank"===c?App.Styler.compute_thresholds_quantiles(a,b):"val"===c?"log"==d?App.Styler.compute_thresholds_logval(a,b):App.Styler.compute_thresholds_val(a,b):void console.log("? --- Unknown threshold type --- ?")):(console.log("compute_thresholds :: skipping"),[0])},compute_thresholds_val:function(a,b){var c=_.min(a),d=_.max(a),e=(d-c)/b,f=_.map(_.range(0,b),function(a){return c+a*e});return f[0]=0,f},compute_thresholds_logval:function(a,b){var c=Math.log(_.chain(a).filter(function(a){return a>0}).min().value())/Math.LN10,d=Math.log(_.max(a))/Math.LN10,e=(d-c)/b,f=_.map(_.range(0,b),function(a){return Math.pow(10,c+a*e)});return f[0]=0,f},compute_thresholds_quantiles:function(a,b){b=_.min([b,a.length]);var c=_.sortBy(a,function(a){return a}),d=a.length/b,e=_.map(_.range(0,b),function(a){return c[Math.round(a*d)]});return e}}),App.RegionStyler=App.Styler.extend({get_layer_params:function(a){var b=this,c=b.make_style(a);return{style:c,onEachFeature:b.make_onEachFeature(a,c)}},set_thresholds:function(){var a=this.get("targetObject.data"),b="metric_val",c=this.get("n_steps"),d=this.get("threshold_type"),e=this.get("threshold_transform"),f=_.chain(a).pluck(b).pluck(d).value(),g=App.Styler.compute_thresholds(f,c,d,e);this.set("thresholds",g)},make_style:function(a){var b=this;return function(c,d){d||(d=!1);var e=a.get("data"),f=a.get("state"),g="metric_val",h=a.get("state.selected"),i=b.get("threshold_type"),j=(b.get("thresholds"),_.where(e,{locus_id:c.properties[App.Helper.locus_property(f)]})[0]);return h&&d===!1&&(d=_.where(h,{locus_id:c.properties[App.Helper.locus_property(f)]}).length>0),!j||j[g]?{weight:2,opacity:1*d,color:config.REGION_BORDER_COLOR,fillColor:j?b.get_color(j[g][i]):"rgba(255, 255, 255, .05)",fillOpacity:config.REGION_BASE_OPACITY+d/5}:void 0}},make_onEachFeature:function(a,b){function c(a){i.filter.on(a)&&(a.target.setStyle(b(a.target.feature,!0)),a.target.feature.properties.is_selected===!0&&a.target.setStyle(b(a.target.feature,!0)),g.update(a.target.feature.properties[App.Helper.locus_property(h)],a.target.feature.properties.NAME))}function d(a){a.target.setStyle(b(a.target.feature,!1)),g.update()}function e(b){var c=b.target.feature.properties[App.Helper.locus_property(h)],d=_.pluck(a.get("state.selected"),"locus_id");0!==_.difference([c],d).length&&a.get("con").transitionToRoute("main",b.target.feature.properties[App.Helper.locus_property(h)])}function f(b){var c=b.target.feature.properties[App.Helper.locus_property(h)],d=_.pluck(a.get("state.selected"),"locus_id");d=_.contains(d,c)?_.difference(d,[c]):_.union(d,[c]);var e=d.join(",");a.get("con").transitionToRoute("main",e)}var g=a.get("con.heatmap.info"),h=a.get("state"),i=a.get("con.leafletDraw");return function(a,b){b.on({mouseover:c,mouseout:d,click:e,contextmenu:f})}}}),App.CityStyler=App.Styler.extend({get_layer_params:function(a){var b=this.make_style(a),c=this.make_onEachFeature(a);return{style:b,pointToLayer:function(a,b){return L.circleMarker(b)},onEachFeature:c}},set_thresholds:function(){var a=_.pluck(this.get("targetObject.data"),"properties"),b="metric_val",c=this.get("n_steps"),d=this.get("threshold_type"),e=this.get("threshold_transform"),f=App.Styler.compute_thresholds(_.pluck(a,b),c,d,e);console.log("CityStyler :: thresholds :: ",f),this.set("thresholds",f)},make_style:function(a){var b=this;return function(a,c){var e="metric_val";b.get("thresholds");return d=a.properties[e],col=b.get_color(d),{radius:b.get_radius(d),fillColor:col,weight:1,opacity:1,color:"grey",fillOpacity:.8}}},make_onEachFeature:function(a){return function(b,c){var d=a.get("state.metric_type.value"),e=a.get("con.metric_type_options"),f='<h1 class="tooltip-header"><center>';f+=b.properties.city_name,f+="</center></h1><h4>"+_.findWhere(e,{value:d}).label,f+=": "+numeral(b.properties.metric_val).format("0,0")+"</h4>",c.bindPopup(L.popup({autoPan:!1}).setContent(f))}}}),App.BranchStyler=App.CityStyler.extend({make_onEachFeature:function(a){return function(b,c){var d=a.get("state.metric_type.value"),e=a.get("con.metric_type_options"),f='<h1 class="tooltip-header"><center>';f+=b.properties.branch_name+"/"+b.properties.city_name,f+="</center></h1><h4>"+_.findWhere(e,{value:d}).label,f+=": "+numeral(b.properties.metric_val).format("0,0")+"</h4>",c.bindPopup(L.popup({autoPan:!1}).setContent(f))}}}),App.SubjectStyler=App.Styler.extend({get_layer_params:function(a){var b,c=this;return"line"==config.SUBJECT_GEO_TYPE&&(b=_.filter(a.get("data"),function(a){return"subject"==a.properties.locus_actor})[0].geometry.coordinates),{style:c.make_style(),pointToLayer:function(a,c){return"point"===config.SUBJECT_GEO_TYPE?L.circleMarker(c):"line"===config.SUBJECT_GEO_TYPE?L.polyline([new L.LatLng(b[1],b[0]),c],{weight:config.SUBJECT_LINE_WEIGHT,opacity:config.SUBJECT_LINE_OPACITY}):void 0},onEachFeature:c.make_onEachFeature()}},set_thresholds:function(){var a=_.pluck(this.get("targetObject.data"),"properties"),b="metric_val",c=this.get("n_steps"),d=this.get("threshold_type"),e=this.get("threshold_transform"),f=App.Styler.compute_thresholds(_.pluck(a,b),c,d,e);this.set("thresholds",f)},make_style:function(){return function(a,b){return{fillColor:config.SUBJECT_GEOPOINT_COLORS[a.properties.locus_actor],color:config.SUBJECT_GEOPOINT_COLORS[a.properties.locus_actor],fillOpacity:.5,opacity:.5,radius:"subject"==a.properties.locus_actor?6:2}}},make_onEachFeature:function(){return function(a,b){var c='<h1 class="tooltip-header"><center>';c+=a.properties.city_name,c+="</center></h1><h5> Filings </h5>",c+=a.properties.id,c+="<h5> Location of </h5>",c+=a.properties.locus_actor,b.bindPopup(c)}},set_legend:function(){return!1},clear_legend:function(){return!1}}),App.Legend=Ember.Object.extend({widget:void 0,title:"",get_html:function(a,b){if(!a)return"<div></div>";for(var c,d,e,f=[],g=0;g<a.length;g++){c=a[g],d=a[g+1],from_nice=numeral(c).format("0.[000]a"),to_nice=numeral(d).format("0.[000]a"),e=b[g];var h=g+1==a.length?from_nice+"+":from_nice+"&ndash;"+to_nice;f.push("<tr><td>"+h+'</td><td> <i style="background:'+e+'"></i> </td></tr>')}return'<div class="legend-title"> '+this.get("title")+" </div> <table>"+f.join("")+"</table>"},change_html:function(a,b){var c=this.get("widget");c._container.innerHTML=this.get_html(a,b)},show:function(){var a=this.get("widget");$(a._container).css("display","block")},hide:function(){var a=this.get("widget");$(a._container).css("display","none")},color_picker_modal:function(a){Ember.Widgets.ModalComponent.popup({primary:{targetObject:a,rawColors:a.get("colors"),colors:a.get("colors").map(function(a){return{value:a}}),numButtons:a.get("colors").length,n_steps:a.get("n_steps"),n_ticks:parseInt(1),n_min:parseInt(2),n_max:parseInt(12),threshold_type:a.get("threshold_type"),headerText:"Legend Colors",confirmText:"Done",cancelText:void 0,confirm:function(){var a=this.get("targetObject"),b=parseInt(this.get("n_steps")),c=[],d=0;for(d=0;d<this.colors.length;d++)c.push(this.colors[d].value);b=$("#color-slider").slider("value"),a.set("colors",c),isNaN(b)?alert("Invalid number!"):a.set("n_steps",b)},classNames:["color-picker-modal"],add_widgets:function(){Ember.$(".basic").spectrum({preferredFormat:"name",showAlpha:!0})},get_colors:function(){return this.get("colors")},contentViewClass:App.ColorPickerModalView}})}}),App.Legend.reopenClass({make:function(a,b,c){c=c||{};var d=App.Legend.create(c),e=L.control({position:"bottomright"});return e.onAdd=function(b){var c=L.DomUtil.create("div","info legend");return c.innerHTML=d.get_html(),c.oncontextmenu=function(b){return d.color_picker_modal(a),!1},c},e.addTo(b),d.set("widget",e),d}}),App.ColorPickerModalView=Ember.View.extend({templateName:"color-picker",didInsertElement:function(){var a=this.get("controller");a.add_widgets(),Ember.$("#color-slider").slider({min:a.get("n_min"),max:a.get("n_max"),step:a.get("n_ticks"),value:a.get("n_steps"),change:function(b,c){a.set("n_steps",c.value)}})},actions:{numColors:function(a){var b=this.get("controller"),c=b.get_colors();"more"===a?c.length<b.get("n_max")&&c.pushObject({value:"red"}):c.length>b.get("n_min")&&c.popObject(),b.set("numButtons",c.length),Ember.run.next(b,b.add_widgets)}}}),App.GFLayer=Ember.Object.extend({name:void 0,map:void 0,con:void 0,state:void 0,params:void 0,init_layer:void 0,layer:void 0,has_layer:function(){return this.get("layer")||void 0},data:[],styler:void 0,endpoint_name:void 0,all_borders:void 0,borders:function(){return this.get("all_borders")[this.get("state.borders_selection.value")]}.property("state.borders_selection.value"),border_selection_did_change:function(){this.pop_layer()}.observes("state.borders_selection.value"),visible:!0,visible_did_change:function(){this.draw_if_visible()}.observes("visible"),draw_if_visible:function(){var a=this,b=this.get("styler");a.get("visible")?(!a.has_layer()&&a.init_layer&&a.init_layer(),b.set_thresholds(),b.set_legend(),a.redraw_layer()):(b.clear_legend(),a.pop_layer())},refresh:function(a){var b,c=this;b=this.get("params"),c.get("visible")||a?(console.log("sending force -- ",c.get("state")),c.get("con.client")[c.get("endpoint_name")](c.get("state"),function(a){console.log("getting -- "),console.log("refreshing data:: ",a),c.set("data",a.data),c.set("eub",a.eub),c.draw_if_visible()},b)):c.draw_if_visible()},pop_layer:function(){this.has_layer()&&(this.get("map").removeLayer(this.get("layer")),this.set("layer",void 0))},reset_layer:function(){if(this.draw_if_visible(),this.has_layer()){var a=this.get("layer");_.map(a._layers,function(b){b.feature.properties.is_selected=!1,a.resetStyle(b)})}},grab:function(a){return a.filter.getBounds()},params_observer:function(){console.log("data layer observing local parameter change"),this.refresh(!0)},bind_params_on_init:function(){var a=this,b=_.keys(this.get("params"));_.map(b,function(b){a.get("params").addObserver(b,a,"params_observer")})}.on("init")}),App.RegionLayer=App.GFLayer.extend({init_layer:function(){var a=this,b=a.get("map"),c=a.get("styler"),d=a.get("borders");if(a.get("visible")){var e=c.get_layer_params(a),f=L.geoJson(d,e);f.addTo(b),a.set("layer",f)}},redraw_layer:function(){var a=this,b=this.get("styler");a.get("layer").setStyle(b.make_style(a))},bounds_from_selected:function(a){var b=this.get("state.borders_selection"),c=_.filter(this.get("layer")._layers,function(c){return c.feature.properties[App.Helper.locus_property(b)]==a[0].locus_id})[0];return c.getBounds()},grab:function(a){var b=this.get("layer"),c=this.get("state.borders_selection");if(void 0!==b){var d=_.chain(b._layers).map(function(c){return a.isWithinSelectedRegion(c),b.resetStyle(c),c.feature.properties.is_selected?c:void 0}).filter(function(a){return void 0!==a}).filter(function(a){return a.feature.properties[App.Helper.locus_property(c)]}).value();return _.map(d,function(a){return{name:a.feature.properties.NAME,locus_id:a.feature.properties[App.Helper.locus_property(c)]}})}}}),App.GFPointLayer=App.GFLayer.extend({redraw_layer:function(){var a=this,b=a.get("data"),c=a.get("map"),d=a.get("styler");if(a.pop_layer(),b){var e=d.get_layer_params(a);layer=L.geoJson(_.filter(b,function(a){return a.geometry.coordinates}),e),layer.addTo(c),a.set("layer",layer)}}}),App.CityLayer=App.GFPointLayer.extend(),App.BranchLayer=App.GFPointLayer.extend(),App.ApsLayer=App.GFPointLayer.extend({params:Ember.Object.create({profile_type:"freq",profile_fieldname:"gfloc.best.id"})}),App.SubjectLayer=App.GFPointLayer.extend({params:Ember.Object.create({single_subject_key:void 0})}),App.Heatmap=Ember.Object.extend({con:void 0,state:void 0,map:function(){return App.LeafletMap.make()}.property(),all_borders:void 0,borders:function(){return this.get("all_borders")[this.get("state.borders_selection.value")]}.property("state.borders_selection.value"),borders_did_change:function(){
cont_us_bounds=[[25,-124],[50,-59]],global_bounds=[[-60,-180],[60,180]],"state"==this.get("state.borders_selection.value")?this.get("map").fitBounds(cont_us_bounds):this.get("map").fitBounds(global_bounds)}.observes("state.borders_selection.value").on("init"),place_list:function(){return App.Helper.make_place_list(this.get("borders"),this.get("state.borders_selection"))}.property("borders"),info:function(){return App.Info.make(this,this.get("con"))}.property(),update_all:function(){var a=this,b=this.get("layer_names");_.map(b,function(b){a.get(b).refresh()})},reset_all:function(){var a=this,b=this.get("layer_names");_.map(b,function(b){a.get(b).reset_layer()})},layer_names:["region","city","branch","subject"],region:function(){var a=App.RegionLayer.create({name:"Regions",con:this.get("con"),map:this.get("map"),state:this.get("state"),endpoint_name:"run_fetch_global",visible:!0,all_borders:this.get("all_borders")});return a.set("styler",App.RegionStyler.create({targetObject:a,colors:config.DEFAULT_REGION_COLORS})),a}.property(),city:function(){var a=App.CityLayer.create({name:"Cities",con:this.get("con"),map:this.get("map"),state:this.get("state"),endpoint_name:"run_fetch_populated_places",visible:!1,all_borders:this.get("all_borders")});return a.set("styler",App.CityStyler.create({targetObject:a,colors:config.DEFAULT_CITY_COLORS,n_steps:3})),a}.property(),branch:function(){var a=App.BranchLayer.create({name:"Branches",con:this.get("con"),map:this.get("map"),state:this.get("state"),endpoint_name:"run_fetch_branches",visible:!1,all_borders:this.get("all_borders")});return a.set("styler",App.BranchStyler.create({targetObject:a,colors:["black","lightgreen","lime"]})),a}.property(),subject:function(){return App.SubjectLayer.create({name:"Subjects",con:this.get("con"),map:this.get("map"),state:this.get("state"),styler:App.SubjectStyler.create(),endpoint_name:"run_fetch_subject_geo",visible:!0,all_borders:this.get("all_borders")})}.property()}),App.LeafletMap=Ember.Object.extend({}),App.LeafletMap.reopenClass({make:function(){console.log((config.TESTING?config.TESTING_DOMAIN:"")+config.TILE_IP);var a=L.map("map",{worldCopyJump:!1,keyboard:!1}).setView([0,0],2);return L.tileLayer((config.TESTING?config.TESTING_DOMAIN:"")+config.TILE_IP,config.LEAFLET_CONFIG).addTo(a),a}}),App.Info=Ember.Object.extend({}),App.Info.reopenClass({make:function(a,b){var c=a.get("map"),d=L.control();return d.onAdd=function(){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},d.update=function(c,d){var e;if(c&&d){var f=_.findWhere(a.get("region.data"),{locus_id:c});f||(f={});var g=["doc_count","locus_id","metric_val"];e='<div id="info-box"><h4>'+d+"</h4>",_.chain(f).keys().difference(g).map(function(a){e+='<h4 style="margin-bottom:0px">'+_.findWhere(b.get("metric_type_options"),{value:a}).label+" : "+numeral(f[a].val).format("0.[00]a")+" </h4><span>(Rank: "+f[a].rank+")</span>"}),e+="</div>",this._div.innerHTML=e}else e+="",this._div.innerHTML=e},d.addTo(c),d}}),App.LeafletDraw=Ember.Object.extend({filter:void 0,isWithinSelectedRegion:function(a){var b,c=this.filter.getBounds();b=c?c.contains(a.getBounds()):!1,a.feature.properties.is_selected=b}}),App.LeafletDraw.reopenClass({make:function(){var a=App.LeafletDraw.create();return a.set("filter",new L.FeatureGroup),a}}),App.State=Ember.Object.extend(App.Serializable,{counter:0,borders_selection:config.BORDER_TYPE_OPTIONS[config.DEFAULT_BORDER_TYPE],start_date:config.DEFAULT_SLIDER_START_DATE,end_date:config.DEFAULT_SLIDER_END_DATE,selected:void 0,selected_bounds:void 0,conditioned:!1,form_types:void 0,user_query:config.SUBSET_OPTIONS[config.DEFAULT_SUBSET],metric_type:config.METRIC_TYPE_OPTIONS[config.DEFAULT_METRIC_TYPE],norm_type:config.NORM_TYPE_OPTIONS[config.DEFAULT_NORM_TYPE],ts_resolution:config.TS_RESOLUTION_OPTIONS[config.DEFAULT_TS_RESOLUTION],exact_geoname:config.DEFAULT_EXACT_GEONAME,active_columns:[],_active_columns:function(){this.set("active_columns",[this.get("metric_type")])}.observes("metric_type.value").on("init"),accuracies:config.DEFAULT_ACCURACIES,clear_state:function(){this.set("selected",void 0),this.set("selected_bounds",void 0),this.set("conditioned",!1)}}),App.MainRoute=App.GRoute.extend({model:function(a){var b,c,d,e,f;if(e=this.get("controller")){if(e.set("prevRoute",App.__container__.lookup("controller:application").get("currentRouteName")),f=this,b=e.get("state"),c=e.get("client"),a.selection_url!=config.DEFAULT_PATH)try{var g=JSON.parse(a.selection_url);console.log("selection_url_json",g),e.get("heatmap.map").fitBounds(g,{animate:!0})}catch(h){c.get_locus_name(a.selection_url,b,function(a){b.set("selected",a),e.send("selected_changed");var c=e.get("prevRoute");console.log("++ prevRoute",c),c&&"main.index"!==c?f.transitionTo(c):f.transitionTo(config.DEFAULT_GFPANEL)},e.get("heatmap.all_borders"))}else{var i=e.get("prevRoute");console.log("++ prevRoute",i),i&&"main.index"!==i?f.transitionTo(i):f.transitionTo(config.DEFAULT_GFPANEL)}return new Ember.RSVP.Promise(function(a,d){Ember.run(this,a,[c,b])})}return b=App.State.create(),d=App.Client.make(config.TESTING?config.TESTING_DOMAIN:config.NODE_PATH),new Ember.RSVP.Promise(function(c,e){d.then(function(d){a.selection_url!=config.DEFAULT_PATH&&d.get_locus_name(a.selection_url,b,function(a){b.set("selected",a)}),Ember.run(this,c,[d,b]),config.DO_MSH&&d.__msh__()})})},setupController:function(a,b){a.set("client",b[0]),a.set("state",b[1])}}),App.MainController=Ember.Controller.extend({needs:["application"],slider_open:!1,client:void 0,state:null,heatmap:void 0,leafletDraw:void 0,locus:void 0,norm_type_options:config.NORM_TYPE_OPTIONS,metric_type_options:config.METRIC_TYPE_OPTIONS,subset_options:config.SUBSET_OPTIONS,border_type_options:config.BORDER_TYPE_OPTIONS,ts_resolution_options:config.TS_RESOLUTION_OPTIONS,snapper:void 0,expanded:!1,tsdata:void 0,dissect_form_type:void 0,dissect_form_type_fields:[],dissect_form_type_field:void 0,dissection:void 0,isAdmin:function(){return App.isAdmin()}.property(),locus_changed:function(){var a=this.get("locus"),b=this.get("state.selected");!a||b&&_.isEqual(a.locii[0],b[0])||this.transitionToRoute("main",_.pluck(a.locii,"locus_id").join(","))}.observes("locus"),state_changed:function(){console.log("! --- state changed --- !",+new Date),this.update_all()},_force_state_change:function(){console.log("! --- force_state_change --- !",+new Date);var a=this.get("state.counter");this.get("state")&&(console.log("! --- counter:",a+1," --- !"),this.set("state.counter",a+1))},force_state_change:function(){Ember.run.debounce(this,"_force_state_change",250+1500*config.TESTING,!0)},state_observer:function(){console.log("! --- state observer --- !"),Ember.run.debounce(this,"force_state_change",250+1500*config.TESTING,!0)}.observes("state.start_date","state.end_date","state.selected","state.selected_bounds","state.form_types","state.norm_type","state.borders_selection","state.user_query","state.ts_resolution","state.exact_geoname","state.metric_type"),borders_selection_changed:function(){this.send("clear_selection")},update_all:function(){this.get("heatmap")?this.get("heatmap").update_all():console.log("? -- no heatmap -- ?")},reset_all:function(){this.get("heatmap")?this.get("heatmap").reset_all():console.log("? -- no heatmap -- ?")},show_form_modal:function(a){var b=this,c=_.findWhere(this.get("state.form_types"),{form_type:a});Ember.Widgets.ModalComponent.popup({primary:{targetObject:b,headerText:c.form_type.toUpperCase().replace("TYPE_","")+" Definitions",confirmText:"Done",cancelText:void 0,content:c,classNames:["form-type-modal"],contentViewClass:App.FormTypeModalView},computed:{actions:{toggle_subfield:function(a){a.toggled?Ember.set(a,"toggled",!1):Ember.set(a,"toggled",!0),b.force_state_change()}}}})},actions:{go_to_default:function(){this.transitionToRoute("main",config.DEFAULT_PATH)},selected_changed:function(){var a=this.get("state.selected"),b=this.get("locus");if(a?1===a.length?b&&a&&_.isEqual(b.locii[0],a[0])||this.set("locus",{name:a[0].name,locii:a}):a.length>1&&this.set("locus",{name:"Multiple Regions",locii:a}):this.set("locus",void 0),a&&(this.get("snapper").open("left"),1===a.length))try{var c=this.get("heatmap.region").bounds_from_selected(a);this.get("heatmap.map").fitBounds(c,{animate:!1});var d=this.get("heatmap.map"),e=config.OFFSET_CONSTANT*d.getSize().x;d.panBy(new L.Point(e,0),{animate:!1})}catch(f){console.log("failing to fit bounds!")}},toggle_form:function(a){var b=_.chain(this.get("state.form_types")).pluck("toggled").filter().value().length;a.toggled&1===b?alert("Cannot disable all form types."):(a.toggleProperty("toggled"),this.force_state_change())},grab_regions:function(){var a=this.get("leafletDraw"),b=this.get("heatmap.region").grab(a),c=_.pluck(this.get("state.selected"),"locus_id").join(","),d=_.pluck(b,"locus_id").join(",");d!==c&""!==d&&(this.send("clear_selection"),this.transitionToRoute("main",d))},grab_cities:function(){this.send("clear_selection");var a=this.get("leafletDraw"),b=this.get("heatmap.city").grab(a);this.set("state.selected_bounds",b),this.transitionToRoute("city"),this.get("snapper").open("left"),this.set("state.selected",!0),this.set("heatmap.city.visible",!0),this.update_all()},clear_selection:function(){this.get("state").clear_state(),this.reset_all(),this.update_all(),this.send("go_to_default")},define_metric:function(){App.AddColumnModal.add_modal(this)}}}),App.MainView=Ember.View.extend({didInsertElement:function(){console.log("& --- inserting main view --- &");var a=this.get("controller"),b=a.get("client"),c=a.get("state");b.get_borders(function(d){c.set("form_types",_.map(b.get("form_types"),function(a){return Ember.Object.create(a)}));var e=App.Heatmap.create({con:a,state:c,all_borders:d});a.set("heatmap",e),$(window).on("resize",function(){var b=a.get("heatmap.map");void 0!==b&&b.invalidateSize(),$(".leaflet-bottom").css("padding-bottom",$("#lower-navbar").css("height"));var c=Math.round($(window).width()*config.SNAPPER_WIDTH);a.get("snapper").settings({maxPosition:c}),$(".drawer-inner").css("width",c)});var f=new Snap({element:document.getElementById("content"),disable:"right"});f.on("open",function(){a.set("slider_open",!0),Ember.run.next(this,function(){Ember.$(window).trigger("resize")})}),f.on("close",function(){a.set("slider_open",!1),Ember.run.next(this,function(){Ember.$(window).trigger("resize")})}),a.set("snapper",f),document.getElementById("open-left").addEventListener("click",function(){a.get("slider_open")===!0?(f.close("left"),a.set("slider_open",!1)):(f.open("left"),a.set("slider_open",!0)),Ember.run.next(this,function(){Ember.$(window).trigger("resize")})}),config.TESTING?(a.set("state.start_date",config.DEFAULT_SLIDER_START_DATE),a.set("state.end_date",config.DEFAULT_SLIDER_END_DATE)):(Ember.$("#slider").dateRangeSlider({bounds:{min:new Date(config.SLIDER_LOWER_LIMIT),max:new Date(config.SLIDER_UPPER_LIMIT)},defaultValues:{min:new Date(config.DEFAULT_SLIDER_START_DATE),max:new Date(config.DEFAULT_SLIDER_END_DATE)},step:{months:config.SLIDER_STEP_IN_MONTHS}}),$("#slider").bind("valuesChanged",function(b,c){a.get("state.start_date")!=c.values.min&&a.set("state.start_date",c.values.min),a.get("state.end_date")!=c.values.max&&a.set("state.end_date",c.values.max)})),document.addEventListener("contextmenu",function(b){"form-select-link"==$(b.target).attr("class")&&(a.show_form_modal($(b.target).attr("id")),b.preventDefault())},!1);var g=a.get("heatmap.map");L.drawLocal.draw.toolbar.buttons.rectangle="Select Regions",L.drawLocal.draw.handlers.rectangle.tooltip.start="Click and Drag to Select Region",L.drawLocal.draw.toolbar.buttons.square="Select Cities",L.drawLocal.draw.handlers.square.tooltip.start="Click and Drag to Select Cities";var h=App.LeafletDraw.make(),i=new L.FeatureGroup;drawControl=new L.Control.Draw({draw:{rectangle:{shapeOptions:{color:"#fff"},repeatMode:!1},square:{shapeOptions:{color:"#fff"},repeatMode:!1},polygon:!1,marker:!1,polyline:!1,circle:!1},edit:{featureGroup:i,remove:!1,edit:!1}}),g.on("draw:created",function(b){var c=b.layerType,d=b.layer;d.addTo(i),h.filter.addLayer(d),"rectangle"===c?a.send("grab_regions"):"square"===c&&a.send("grab_cities"),h.filter.removeLayer(d)}),g.addControl(drawControl),a.set("leafletDraw",h),$(".nav-tabs-sidebar li").on("click",function(a){Ember.$(".nav-tabs-sidebar li").not(Ember.$(a.target.parentNode)).removeClass("clicked"),Ember.$(a.target.parentNode).addClass("clicked")}),a.update_all(),c.addObserver("counter",a,"state_changed"),c.addObserver("borders_selection.value",a,"borders_selection_changed"),Ember.$(window).trigger("resize")})}}),App.GfSelectComponent=Ember.Widgets.SelectComponent.extend({}),App.BuilderController=Ember.Controller.extend({needs:["main"],client:Ember.computed.alias("controllers.main.client"),state:Ember.computed.alias("controllers.main.state"),editor:"",subset_options:Ember.computed.alias("controllers.main.subset_options"),subset_query:"",norm_type_options:Ember.computed.alias("controllers.main.norm_type_options"),fix_forms:!0,fix_metric:!0,fix_time:!0,metric_type_options:Ember.computed.alias("controllers.main.metric_type_options"),form_type_options:Ember.computed.alias("controllers.main.state.form_types"),form_type_selections:[],locus_actor_options:[],locus_actor_selections:[],field_options:[],field_selection:void 0,all_statistic_options:config.ALL_STATISTIC_OPTIONS,statistic_options:[],statistic:void 0,form_type_selections_did_change:function(){var a=this,b=_.chain(this.get("form_type_selections")).pluck("locus_actors").flatten().map(JSON.stringify).uniq().map(JSON.parse).value();this.set("locus_actor_options",b),this.get("client").run_fetch_form_type_fields(a.get("form_type_selections"),function(b){a.set("field_options",b)})}.observes("form_type_selections.@each"),field_selection_did_change:function(){var a=this.get("field_selection.type");_.contains(["float","double","long"],a)&&(a="number"),this.set("statistic_options",this.get("all_statistic_options")[a])}.observes("field_selection.type"),validate_query:function(a,b){Ember.$.ajax({type:"POST",url:config.NODE_PATH+"/validate",contentType:"application/json",dataType:"json",data:JSON.stringify(a),success:function(a){b(a.valid)}})},actions:{add_subset_query:function(a){var b={label:a,value:a.toLowerCase(),pre_def:{type:"query_string",query:{string:a}}};this.get("subset_options").pushObject(b),this.set("subset_query","")},show_mapping:function(){var a=this.get("mapping_viewer");this.get("client").get_mapping(function(b){a.getSession().setValue(JSON.stringify(b,null,"  "))})},add_complex_subset_query:function(){var a=this,b={};console.log("self.get editor",this.get("editor"));try{b=this.get("editor").getSession().getValue()}catch(c){console.log(c)}try{subset_query_name="complex_query_"+ +new Date;var d=JSON.parse(b),e={label:subset_query_name,value:subset_query_name.toLowerCase(),pre_def:{type:"explicit",query:d}};this.validate_query(d,function(b){console.log("valid",b),b?a.get("subset_options").pushObject(e):alert("Invalid query!")})}catch(c){alert("Custom query is invalid JSON! Please, look up the Elasticsearch query language for more information.",c)}},add_metric:function(){var a=this,b=Ember.Object.create({pre_def:{type:"parameterized",content:{id:+new Date,form_types:_.pluck(a.get("form_type_selections"),"form_type"),locus_actors:_.pluck(a.get("locus_actor_selections"),"locus_actor"),field:this.get("field_selection.field"),statistic:this.get("statistic.value")}}}),c=+new Date;b.label=[b.pre_def.content.id].join("_").replace(/\./g,"-"),b.value="mt_"+c,b.pre_def.content.name="mt_"+c,this.get("metric_type_options").pushObject(b)},remove_option:function(a,b){this.set(b,_.filter(this.get(b),function(b){return b.value!=a.value}))},remove_norm_type_option:function(a){console.log("row",a),this.send("remove_option",a,"norm_type_options")},persist_comparison:function(){var a=this.get("state"),b=Ember.Object.create({pre_def:{type:"realtime",fix_time:this.get("fix_time"),fix_forms:this.get("fix_forms"),fix_metric:this.get("fix_metric"),state:JSON.parse(JSON.stringify(a.serialize()))}}),c=+new Date;b.label="New Comparison",b.value="nrm_"+c,b.pre_def.name="nrm_"+c,this.get("norm_type_options").pushObject(b)}}}),App.DefineSubsetController=App.BuilderController.extend({}),App.DefineSubsetView=Ember.View.extend({didInsertElement:function(){if($("#editor").length>0){var a=ace.edit("editor");a.setTheme("ace/theme/monokai"),a.getSession().setMode("ace/mode/javascript"),this.set("controller.editor",a)}if($("#mapping-viewer").length>0){var b=ace.edit("mapping-viewer");b.setTheme("ace/theme/monokai"),b.setReadOnly(!0),b.getSession().setMode("ace/mode/javascript"),this.set("controller.mapping_viewer",b)}}}),App.SubsetPopoverContentView=Ember.View.extend({templateName:"subset-popover-content"}),App.DefineMetricController=App.BuilderController.extend({}),App.MetricPopoverContentView=Ember.View.extend({templateName:"metric-popover-content"}),App.DefineCompareController=App.BuilderController.extend({}),App.ComparePopoverContentView=Ember.View.extend({templateName:"compare-popover-content"}),App.MetricDefinitionView=Ember.View.extend({templateName:"metric-definition",special:!1,explicit:!1,didInsertElement:function(){var a=this.get("pre_def");"special"===a.type?this.set("special",!0):"explicit"===a.type&&this.set("explicit",!0)}}),Ember.Handlebars.helper("stringify",function(a,b){return new Ember.Handlebars.SafeString(JSON.stringify(a))});var registerRowProperty=function(a){return function(b,c){var d,e;return e=this.get("rowContent"),d=this.get("column"),e&&d?(1===arguments.length?c=d[a](e):d.setCellContent(e,c),c):void 0}};App.TimeSeriesSparkCellHeaderView=Ember.Table.HeaderCell.extend({templateName:"table_cells/time-series-header-cell",didInsertElement:function(){this._super();var a=this;$("#time-series-context").contextmenu({target:"#time-series-context-menu",onItem:function(b,c){a.send("toggle_property",$(c.target).attr("id")),$(c.target).toggleClass("context-menu-selected")}})},click:function(){console.log("clicking disabled... right click instead...")},actions:{toggle_property:function(a){this.toggleProperty("controller."+a,!0)}}}),App.ServerHeaderCell=Ember.Table.HeaderCell.extend({templateName:"table_cells/server-header-cell",targetDataPath:"data",server_sort_simple_column:function(a,b){var c=this,d=(a.get("content"),a.get("current_sorted_column")),e=b.content.can_sort;if(e){var f=b.content.sortPath||b.content.contentPath;d==f?a.toggleProperty("reverseSort"):a.set("reverseSort",!0);var g=a.get("reverseSort"),h=a.get("targetObject");return h.set("sortBy",f),h.set("reverse",g),h.set("page",0),h.get("fetchers")[h.get("current_fetcher")]({sortBy:f,reverse:g,page:0},function(b){a.set("current_sorted_column",f),a.set("content",b.reports),h.set(c.get("targetDataPath"),b)}),g}},click:function(a){var b=$(a.target).parents(".ember-table-cell"),c=b.attr("id"),d=Ember.View.views[c];if(d){d.set("sortingOn",!0);var e=this.server_sort_simple_column(this.get("controller"),d);d.set("reversed",e)}var f=b.parent().children();_.map(f,function(a){console.log("$siblingView",[a]);var b=$(a).attr("id");if(b!=c){var d=Ember.View.views[b];d&&d.set("sortingOn",!1)}})}}),App.TreeTableCell=Ember.Table.TableCell.extend({templateName:"table_cells/financial-table-cell",cellContent_pct:Ember.computed(registerRowProperty("getCellContent_pct")).property("rowContent.isLoaded","column"),cellContent_rank:Ember.computed(registerRowProperty("getCellContent_rank")).property("rowContent.isLoaded","column")}),App.RankedTableCell=Ember.Table.TableCell.extend({templateName:"table_cells/ranked-table-cell",classNames:"table_cells/ranked-table-cell",cellContent_rank:Ember.computed(registerRowProperty("getCellContent_rank")).property("rowContent.isLoaded","column"),highlighted:Ember.computed(registerRowProperty("getHighlighted")).property("rowContent.isLoaded","column")}),App.BranchTableCell=Ember.Table.TableCell.extend({templateName:"table_cells/branch-table-cell",cellContent_branch:Ember.computed(registerRowProperty("getCellContent_branch")).property("rowContent.isLoaded","column"),cellContent_loc:Ember.computed(registerRowProperty("getCellContent_loc")).property("rowContent.isLoaded","column"),cellContent_address:Ember.computed(registerRowProperty("getCellContent_address")).property("rowContent.isLoaded","column")}),App.SparkCellView=Ember.Table.TableCell.extend({template:Ember.Handlebars.compile(""),scale:Ember.computed.alias("controller.scale"),log:Ember.computed.alias("controller.log"),heightBinding:"controller.rowHeight",update:function(){return this.$("svg")&&this.$("svg").remove(),void 0!==this.renderD3View?this.renderD3View():!1},onWidthDidChange:Ember.observer(function(){this.update()},"width"),contentDidChange:Ember.observer(function(){this.update()},"row"),didInsertElement:function(){this.update()},onScaleDidChange:function(){this.update()}.observes("scale","log")}),App.FinancialTableSparkCell=App.SparkCellView.extend({templateName:"table_cells/financial-table-spark-cell",cellContent_pct:Ember.computed(registerRowProperty("getCellContent_pct")).property("rowContent.isLoaded","column"),cellContent_ts:Ember.computed(registerRowProperty("getCellContent_ts")).property("rowContent.isLoaded","column"),ts_resolution:Ember.computed(registerRowProperty("get_ts_resolution")).property("rowContent.isLoaded","column"),renderD3View:function(){try{var a=Ember.$(this.get("element")).parent().parent();if(a){var b=a.parent().children();this.set("index",b.index(a))}App.D3Engine.make_time_series(this.get("cellContent_ts"),this.get("ts_resolution"),this)}catch(c){console.log("+ Financial table could not draw spark cell +"),console.log(c)}}}),App.TimeSeriesSparkCellView=App.SparkCellView.extend({ts_resolution:Ember.computed(registerRowProperty("get_ts_resolution")).property("rowContent.isLoaded","column"),renderD3View:function(){try{var a=Ember.$(this.get("element")).parent().parent();if(a){var b=a.parent().children();this.set("index",b.index(a))}App.D3Engine.make_time_series(this.get("row.timeseries"),this.get("ts_resolution"),this)}catch(c){console.log("+ Financial table could not draw spark cell +"),console.log(c)}}}),App.TypeSparkCellView=App.SparkCellView.extend({renderD3View:function(){var a="row.types",b="key";App.D3Engine.make_histogram(this,a,b)}}),App.D3Engine=Ember.Object.extend(),App.D3Engine.reopenClass({date_diff:function(a,b,c){return App.D3Engine[a+"_diff"](b,c)},day_diff:function(a,b){return b.getDay()-a.getDay()+31*App.D3Engine.month_diff(a,b)},week_diff:function(a,b){return App.D3Engine.day_diff(a,b)/7},month_diff:function(a,b){return b.getMonth()-a.getMonth()+12*App.D3Engine.year_diff(a,b)},year_diff:function(a,b){return b.getFullYear()-a.getFullYear()},validate_time_series:function(a){return a&&a.xmin&&a.xmax},make_time_series:function(a,b,c){if(App.D3Engine.validate_time_series(a)){var d=c.get("index"),e=c.get("height"),f=c.get("width"),g=d3.time.format("%Y-%m-%d").parse,h=_.map(a.data,function(a){return{date:g(App.Helper.dateToYMD(new Date(a.key))),value:+a.metric_val}});c.get("log")&&_.map(h,function(a){a.value=_.max([0,Math.log(a.value)/Math.LN10])});var i=App.D3Engine.date_diff(b.value,new Date(a.xmin),new Date(a.xmax)),j=_.max([1,(1-config.SPARKCELL_INTER_BAR_PADDING)*(f/Math.ceil(i))]),k=d3.select("#"+c.get("elementId")).append("svg:svg").attr("height",e).attr("width",f),l=d3.time.scale().range([0,f]);l.domain(d3.extent([h,{date:a.xmax},{date:a.xmin}],function(a){return a.date})).nice();var m=d3.svg.axis().scale(l).orient("bottom").tickSize(3).ticks(4).tickPadding(0).tickFormat(d3.time.format("%b-%y"));k.append("g").attr("class","x axis").attr("width",j).attr("transform","translate("+f+",0) rotate(180) translate("+f+",0) rotate(180)").call(m).selectAll("text").style("text-anchor","end").attr("dx","2.0em"),d%4!==0&&k.selectAll("text").remove();var n=d3.scale.linear().range([0,e*(1-config.SPARKCELL_ABOVE_BAR_PADDING)]);n.domain([0,_.max(_.pluck(h,"value"))]),k.selectAll("bar").data(h).enter().append("rect").style("fill",config.SPARKCELL_TS_COLOR).attr("x",function(a){return l(a.date)}).attr("width",j).attr("y",function(a){return e+11-n(a.value)}).attr("height",function(a){return n(a.value)}).on("mouseover",function(a){d3.select(this).style("fill",function(){return config.SPARKCELL_TS_HOVER_COLOR}),d3.select(this).attr("width",function(){return j+1})}).on("mouseout",function(a){d3.select(this).style("fill",function(){return config.SPARKCELL_TS_COLOR}),d3.select(this).attr("width",function(){return j})}).append("title").text(function(a){return a.date.toDateString()+" / "+numeral(a.value).format("0.0a")})}},make_histogram:function(a,b,c){var d=a.get(b);if(d){var e=a.get("height"),f=a.get("width"),g=_.reduce(_.pluck(d,"metric_val"),function(a,b){return a+b}),h=d3.scale.linear().range([0,f]).domain([0,d.length]),i=d3.scale.linear().range([e*(1-config.SPARKCELL_ABOVE_BAR_PADDING),0]).domain([0,g]),j=_.max([1,(1-config.SPARKCELL_INTER_BAR_PADDING)*(f/d.length)]),k=d3.select("#"+a.get("elementId")).append("svg:svg").attr("height",e).attr("width",f);k.selectAll("bar").data(d).enter().append("rect").style("fill",config.SPARKCELL_HIST_COLOR).attr("x",function(a,b){return h(b)}).attr("width",j).attr("y",function(a){return i(a.metric_val)+e*config.SPARKCELL_ABOVE_BAR_PADDING}).attr("height",function(a){return e*(1-config.SPARKCELL_ABOVE_BAR_PADDING)-i(a.metric_val)}).on("mouseover",function(a){d3.select(this).style("fill",function(){return config.SPARKCELL_HIST_HOVER_COLOR})}).on("mouseout",function(a){d3.select(this).style("fill",function(){return config.SPARKCELL_HIST_COLOR})}).append("title").text(function(a){return a[c]+" / "+a.metric_val})}}}),App.ContextMenuHeaderCellView=Ember.Table.HeaderCell.extend({templateName:"table_cells/context-menu-header-cell"}),App.GFPanelRoute=App.GRoute.extend({setupController:function(a,b){console.log("trying to set up controller...");var c=_.chain(a.get("state").observersForKey("counter")).map(function(a){return a[0]}).contains(a).value();c||a.state_observer(),a.get("state").addObserver("counter",a,"state_observer")},deactivate:function(){var a=this.get("controller");a.get("state").removeObserver("counter",a,"state_observer")}}),App.GFPanelController=Ember.Controller.extend(Ember.Evented,{needs:["main","application"],client:Ember.computed.alias("controllers.main.client"),state:Ember.computed.alias("controllers.main.state"),all_borders:Ember.computed.alias("controllers.main.heatmap.all_borders"),isAdmin:function(){return App.isAdmin()}.property(),col_width:150,set_col_width:function(){var a=this.get("table_columns")?this.get("table_columns").length:4,b=$(".drawer-inner").width()/a-1;b>0&&this.set("col_width",b)}.observes("table_columns.length").on("init"),clear_data:function(){this.set("table_data",void 0),this.set("eub",void 0)},table_data:void 0,table_columns:void 0,eub:void 0,name:"no-name-controller"}),App.GFPanelIndependantController=App.GFPanelController.extend({state_observer:function(){console.log(")))))))) "+this.get("name")+" observer firing ))))))))"),this.send("get_table_data")}}),App.GFPanelLinkedController=App.GFPanelController.extend({linked_to:void 0,state_observer:function(){this.get("data_layer")&&!this.get("visible")?(console.log(")))))))) "+this.get("name")+" observer firing -- getting new data (forcing refresh)"),this.send("refresh_underlying_data")):console.log(")))))))) "+this.get("name")+" observer firing -- doing nothing")},defineComputed:function(){var a=this.get("linked_to");Ember.defineProperty(this,"data_layer",Ember.computed.alias("controllers.main.heatmap."+a)),Ember.defineProperty(this,"table_data",Ember.computed.alias("controllers.main.heatmap."+a+".data")),Ember.defineProperty(this,"visible",Ember.computed.alias("controllers.main.heatmap."+a+".visible")),Ember.defineProperty(this,"eub",Ember.computed.alias("controllers.main.heatmap."+a+".eub"))}.on("init"),actions:{refresh_underlying_data:function(){this.get("data_layer").refresh(!0)}}}),App.GlobalRoute=App.GFPanelRoute.extend(),App.GlobalController=App.GFPanelLinkedController.extend({name:"global",linked_to:"region",active_columns:Ember.computed.alias("controllers.main.state.active_columns"),active_columns_did_change:function(){this.send("refresh_underlying_data")}.observes("active_columns.@each"),table_columns:function(){var a=this,b=this.get("state.borders_selection"),c=this.get("col_width"),d=this.get("all_borders"),e=this.get("active_columns");return _.flatten([Ember.Table.ColumnDefinition.create({defaultColumnWidth:c,textAlign:"text-align-left",headerCellName:"ID",contentPath:"locus_id",getCellContent:function(a){return App.Helper.iso2name(a.locus_id,b,d)+" ("+a.locus_id+")"},can_sort:!0}),_.map(e,function(b){console.log("col",b);var d=b.value;return Ember.Table.ColumnDefinition.create({defaultColumnWidth:c,headerCellName:"'"+b.label+"'",contentPath:d+".val",tableCellViewClass:"App.RankedTableCell",getCellContent:function(a){var b=d.match("amount")||d.match("amnt")?" ($)":"";return a[d].val>1e3?numeral(a[d].val).format("0.000a")+b:numeral(a[d].val).format("0.00")+b},getCellContent_rank:function(a){return a[d].rank},getHighlighted:function(b){var c=a.get("state.selected");return _.where(c,{locus_id:b.locus_id}).length>0},can_sort:!0,rank:100})})])}.property("table_data"),actions:{export_data:function(){var a=_.map(this.get("table_data"),App.Helper.flattenJSON),b=_.keys(a[0]).join(","),c=_.map(a,function(a){return _.values(a).join(",")}).join("\n");App.Helper.download(b+"\n"+c,"global_download_"+ +new Date+".csv","text/csv")}}}),App.RegionRoute=App.GFPanelRoute.extend(),App.RegionController=App.GFPanelIndependantController.extend({name:"region",visible:Ember.computed.alias("controllers.main.heatmap.region.visible"),groupingColumn:Ember.computed(function(){var a=this.get("col_width"),b=this.get("state.borders_selection"),c=this.get("all_borders");return Ember.Table.ColumnDefinition.create({headerCellName:"",columnWidth:a,isTreeColumn:!0,isSortable:!0,textAlign:"text-align-left",headerCellViewClass:"App.FinancialTableHeaderTreeCell",tableCellViewClass:"App.FinancialTableTreeCell",contentPath:"group_value",getCellContent:function(a){return"Country"==a.group_name?App.Helper.iso2name(a.group_value,b,c):a.group_value.replace("TYPE_","")},can_sort:!1})}).property("table_data.grouping_factors.@each","table_data","state.borders_selection.value","col_width"),table_columns:Ember.computed(function(){var a,b,c,d;return c=this,this.get("table_data")?(b=this.get("table_data.value_factors"),d=this.get("state.ts_resolution"),b?(a=_.map(b,function(a,b){return Ember.Table.ColumnDefinition.create({index:b,columnWidth:c.get("col_width"),headerCellName:a.display_name,headerCellViewClass:"App.FinancialTableHeaderCell",tableCellViewClass:a.is_time_series?"App.FinancialTableSparkCell":"App.TreeTableCell",can_sort:!a.is_time_series,can_scale:a.is_time_series,get_ts_resolution:function(){return c.get("state.ts_resolution")},getCellContent:function(a){var b;try{var c=a.values[this.get("index")];b=c.value,b=parseInt(b),b>1e3&&(b=numeral(b).format("0,0"))}catch(d){b=""}return b},getCellContent_pct:function(a){var b=a.values[this.get("index")];return b.pct},getCellContent_ts:function(a){var b=a.values[this.get("index")];return b.timeseries},getCellContent_rank:function(a){var b=a.values[this.get("index")];return b.rank}})}),a.unshiftObject(this.get("groupingColumn")),a):void 0):void 0}).property("table_data"),selected_did_clear:function(){this.set("table_data",void 0)}.observes("state.selected"),actions:{get_table_data:function(){var a=this;a.get("client").run_fetch_locus(a.get("state"),function(b){a.set("table_data",b.data)})},run_selected_reports:function(){function a(a,d){a.data_type="region",a.n_reports=100,b.run_fetch_reports(c,a,function(a){Ember.run(this,d,a)})}var b=this.get("client"),c=this.get("state"),d=this.get("controllers.main");App.Report.make_report_modal({fetchers:{filtered:a},controller:d,
title:"Reports for "+_.map(c.get("selected"),function(a){return a.name}).join(", ")})}}}),App.CityRoute=App.GFPanelRoute.extend(),App.CityController=App.GFPanelLinkedController.extend({name:"city",linked_to:"city",table_columns:function(){console.log("making table columns");var a=this,b=this.get("col_width");return[Ember.Table.ColumnDefinition.create({defaultColumnWidth:1*b,textAlign:"text-align-left",headerCellName:"Name",contentPath:"properties.city_name",can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:.5*b,headerCellName:"'"+this.get("state.metric_type.label")+"'",contentPath:"properties.metric_val",getCellContent:function(a){return a.properties.metric_val>1e3?numeral(a.properties.metric_val).format("0.0a"):a.properties.metric_val},can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:1.5*b,headerCellName:"'"+this.get("state.metric_type.label")+"' Over Time",headerCellViewClass:"App.TimeSeriesSparkCellHeaderView",tableCellViewClass:"App.TimeSeriesSparkCellView",getCellContent:"properties.timeseries",can_sort:!1,can_scale:!0,get_ts_resolution:function(){return a.get("state.ts_resolution")}}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:1*b,headerCellName:"'"+this.get("state.metric_type.label")+"' By Type",tableCellViewClass:"App.TypeSparkCellView",getCellContent:"properties.types",can_sort:!1,get_ts_resolution:function(){return a.get("state.ts_resolution")}})]}.property("state.metric_type.label"),table_onClick:function(a,b){function c(b,c){b.data_type="city",b.selected_city={properties:{key:a.properties.key}},b.n_reports=100,d.run_fetch_reports(e,b,function(a){Ember.run(this,c,a)})}var d=b.get("client"),e=b.get("state");App.Report.make_report_modal({fetchers:{filtered:c},controller:b,title:"Reports for "+a.properties.city})},table_onMouseEnter:function(a,b){var c=b.get("data_layer.layer");if(c){console.log("data_layer :: ",c),console.log("city_row :: ",a);var d=_.findWhere(c._layers,function(b){return b.feature.properties.key===a.properties.key});d.bringToFront(),d.openPopup()}},table_onMouseLeave:function(a,b){var c=b.get("data_layer.layer");c&&_.map(c._layers,function(a){return a.closePopup()})},actions:{export_data:function(){var a=this.get("table_data"),b=_.map(a,function(a){var b=a.properties.loc,c=_.omit(a.properties,"loc"),d=_.extend(b,c),e=_.values(d).join(","),f=_.map(a.types,function(a){return e+","+_.values(_.omit(a,"count")).join(",")}).join("\n"),g=_.map(a.timeseries.data,function(a){return e+","+_.values(_.omit(a,"count")).join(",")}).join("\n");return{properties:e,types:f,timeseries:g}}),c=_.keys(a[0].properties);c.unshift("lon","lat");var d=c.join(","),e={properties:d,types:d+","+_.keys(_.omit(a[0].types[0],"count")).join(","),timeseries:d+","+_.keys(_.omit(a[0].timeseries.data[0],"count")).join(",")};_.map(_.keys(e),function(a){var c=_.pluck(b,a).join("\n"),d=e[a];App.Helper.download(d+"\n"+c,a+"_city_download_"+ +new Date+".csv","text/csv")})},run_er_cities:function(a){function b(b,c){b.resolved=a,d.run_fetch_er_cities(b,e,function(a){Ember.run(this,c,a)})}var c=this,d=this.get("client"),e=this.get("state");App.ER.make_er_modal({fetch_er_cities:b},c,a?"Resolved Cities":"Unresolved Cities")}}}),App.BranchRoute=App.GFPanelRoute.extend(),App.BranchController=App.GFPanelLinkedController.extend({name:"branch",linked_to:"branch",table_columns:function(){console.log("making table columns");var a=this,b=this.get("col_width");return[Ember.Table.ColumnDefinition.create({defaultColumnWidth:b,textAlign:"text-align-left",headerCellName:"Name",contentPath:"properties.city_name",tableCellViewClass:"App.BranchTableCell",getCellContent_loc:function(a){return console.log("row",a),a.properties.city_name},getCellContent_branch:function(a){return a.properties.branch_name},getCellContent_address:function(a){return a.properties.address},can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:.5*b,headerCellName:"'"+this.get("state.metric_type.label")+"'",contentPath:"properties.metric_val",getCellContent:function(a){return a.properties.metric_val>1e3?numeral(a.properties.metric_val).format("0.0a"):a.properties.metric_val},can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:1.5*b,headerCellName:"'"+this.get("state.metric_type.label")+"' Over Time",headerCellViewClass:"App.TimeSeriesSparkCellHeaderView",tableCellViewClass:"App.TimeSeriesSparkCellView",getCellContent:"properties.timeseries",can_sort:!1,can_scale:!0,get_ts_resolution:function(){return a.get("state.ts_resolution")}}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:1*b,headerCellName:"'"+this.get("state.metric_type.label")+"' By Type",tableCellViewClass:"App.TypeSparkCellView",getCellContent:"properties.types",can_sort:!1,get_ts_resolution:function(){return a.get("state.ts_resolution")}})]}.property("state.metric_type.label"),table_onClick:function(a,b){function c(b,c){b.data_type="branch",b.selected_branch={properties:{key:a.properties.key}},b.n_reports=100,d.run_fetch_reports(e,b,function(a){Ember.run(this,c,a)})}var d=b.get("client"),e=b.get("state");App.Report.make_report_modal({fetchers:{filtered:c},controller:b,title:"Reports for "+a.properties.branch_name+","+a.properties.address+", "+a.properties.city})},table_onMouseEnter:function(a,b){var c=b.get("data_layer.layer");if(c){var d=_.findWhere(c._layers,function(b){return b.feature.properties.locus_id===a.properties.locus_id&&b.feature.properties.address===a.properties.address});d.bringToFront(),d.openPopup()}},table_onMouseLeave:function(a,b){var c=b.get("data_layer.layer");c&&_.map(c._layers,function(a){return a.closePopup()})},actions:{export_data:function(){var a=this.get("table_data"),b=_.map(a,function(a){var b=a.properties.loc,c=_.omit(a.properties,"loc"),d=_.extend(b,c),e=_.values(d).join(","),f=_.map(a.types,function(a){return e+","+_.values(_.omit(a,"count")).join(",")}).join("\n"),g=_.map(a.timeseries.data,function(a){return e+","+_.values(_.omit(a,"count")).join(",")}).join("\n");return{properties:e,types:f,timeseries:g}}),c=_.keys(a[0].properties);c.unshift("lon","lat");var d=c.join(","),e={properties:d,types:d+","+_.keys(_.omit(a[0].types[0],"count")).join(","),timeseries:d+","+_.keys(_.omit(a[0].timeseries.data[0],"count")).join(",")};_.map(_.keys(e),function(a){var c=_.pluck(b,a).join("\n"),d=e[a];App.Helper.download(d+"\n"+c,a+"_branch_download_"+ +new Date+".csv","text/csv")})}}}),App.SubjectRoute=App.GFPanelRoute.extend(),App.SubjectController=App.GFPanelIndependantController.extend({name:"subject",single_subject:void 0,single_subject_key:Ember.computed.alias("controllers.main.heatmap.subject.params.single_subject_key"),single_subject_did_change:function(){this.set("single_subject_key",this.get("single_subject.key"))}.observes("single_subject.key"),subject_search:void 0,table_columns:function(){var a=this,b=this.get("col_width");return[Ember.Table.ColumnDefinition.create({defaultColumnWidth:b,textAlign:"text-align-left",headerCellName:"Subject ID",contentPath:"key",can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:b,textAlign:"text-align-left",headerCellName:"'"+this.get("state.metric_type.label")+"'",contentPath:"metric_val",can_sort:!0,getCellContent:function(a){return console.log("row",a),a.metric_val>1e3?numeral(a.metric_val).format("0.0a"):a.metric_val}}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:2*b,headerCellName:"'"+this.get("state.metric_type.label")+"' Over Time",headerCellViewClass:"App.TimeSeriesSparkCellHeaderView",tableCellViewClass:"App.TimeSeriesSparkCellView",getCellContent:"timeseries",can_sort:!1,can_scale:!0,get_ts_resolution:function(){return a.get("state.ts_resolution")}}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:b,headerCellName:"'"+this.get("state.metric_type.label")+"' By Type",tableCellViewClass:"App.TypeSparkCellView",getCellContent:"types",can_sort:!1})]}.property("state.metric_type.label"),table_onClick:function(a,b){function c(b,c){b.data_type="subject",b.single_subject=a,b.n_reports=100,d.run_fetch_reports(e,b,function(a){Ember.run(this,c,a)})}var d=b.get("client"),e=b.get("state");App.Report.make_report_modal({fetchers:{unfiltered:c},controller:b,title:"All Reports for ID "+a.key})},table_onRightClick:function(a,b){return console.log("bad actor table on right click",b),b.set("single_subject",a),!1},_get_table_data:function(a){var b=this;b.get("client").run_fetch_subjects(b.get("state"),function(a){b.set("table_data",a.data),b.set("eub",a.eub)},a)},actions:{search_subject:function(a){this._get_table_data(a)},clear_subject:function(){this.set("single_subject",void 0)},get_table_data:function(){this.get("subject_search")?this.send("search_subject",this.get("subject_search")):Ember.run.debounce(this,"_get_table_data",500,!0)},export_data:function(){var a=this.get("table_data"),b=_.map(a,function(a){var b=a.key+","+a.count,c=_.map(a.types,function(a){return b+","+_.values(_.omit(a,"count")).join(",")}).join("\n"),d=_.map(a.timeseries.data,function(a){return b+","+_.values(_.omit(a,"count")).join(",")}).join("\n");return{properties:b,types:c,timeseries:d}}),c={properties:["id","n_filings"].join(","),types:["id","n_filings"].join(",")+","+_.keys(_.omit(a[0].types[0],"count")).join(","),timeseries:["id","n_filings"].join(",")+","+_.keys(_.omit(a[0].timeseries.data[0],"count")).join(",")};_.map(_.keys(c),function(a){var d=_.pluck(b,a).join("\n"),e=c[a];App.Helper.download(e+"\n"+d,a+"_subject_download_"+ +new Date+".csv","text/csv")})}}}),App.MorelikethisRoute=App.GFPanelRoute.extend(),App.MorelikethisController=App.GFPanelIndependantController.extend({name:"morelikethis",table_columns:function(){var a=this.get("col_width");return[Ember.Table.ColumnDefinition.create({defaultColumnWidth:a,textAlign:"text-align-left",headerCellName:"Region",contentPath:"name",getCellContent:function(a){return a.name},can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:a/2,headerCellName:"Relevant Filings",contentPath:"tot",can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:a/2,headerCellName:"Similarity Rank",contentPath:"rank",can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:1.5*a,headerCellName:"Distribution Over Form Types",tableCellViewClass:"App.MoreLikeThisSparkCellView",contentPath:"proportions",can_sort:!1})]}.property(),actions:{get_table_data:function(){var a=this,b=this.get("client"),c=this.get("state");b.run_fetch_more_like_this(c,function(b){console.log("more like this",b);var c=a.get("controllers.main.heatmap.place_list"),d=_.filter(_.map(b,function(a){var b=_.filter(c,function(b){return b.locii[0].locus_id==a.name.toUpperCase()})[0];return b?a.name=b.name:a.name="",a}),function(a){return""!==a.name});a.set("table_data",d)})}}}),App.MoreLikeThisView=Ember.View.extend({templateName:"morelikethis",more_like_this_did_change:function(){this.rerender()}.observes("more_like_this")}),App.ApsRoute=App.GFPanelRoute.extend({}),App.ApsController=App.GFPanelLinkedController.extend({name:"aps",linked_to:"aps",profile_type:Ember.computed.alias("controllers.main.heatmap.aps.params.profile_type"),profile_type_sig:!1,profile_type_did_change:function(){console.log("profile_type_sig did change"),this.get("profile_type_sig")?this.set("profile_type","sig"):this.set("profile_type","freq")}.observes("profile_type_sig"),table_columns:function(){var a=this.get("col_width");return[Ember.Table.ColumnDefinition.create({defaultColumnWidth:1*a,textAlign:"text-align-left",headerCellName:"Name",contentPath:"properties.city_name",can_sort:!0}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:.75*a,headerCellName:"Count",contentPath:"properties.count",getCellContent:function(a){return a.properties.count>1e3?numeral(a.properties.count).format("0.0a"):a.properties.count},can_sort:!0})]}.property()}),App.ProfilerRoute=App.GFPanelRoute.extend({}),App.ProfilerController=App.GFPanelIndependantController.extend({name:"profiler",child_data:void 0,title:function(){return _.pluck(this.get("state.selected"),"name").join(", ")}.property("state.selected"),actions:{get_table_data:function(){var a=this;this.get("client").run_fetch_form_type_fields(a.get("state.form_types"),function(b){a.set("child_data",App.PWidgetData.create({form_type_fields:b,top_level:!0}))})}}}),App.PWidgetData=Ember.Object.extend({form_type_fields:void 0,profile_field:void 0,profile_type:"freq",data:void 0,top_level:!1,subset:[],pretty_subset:function(){return"Universe: Location + "+_.map(this.get("subset"),function(a){return[a.field.field,a.key].join(":")}).join(" + ")}.property("subset"),parents:function(){var a=JSON.parse(JSON.stringify(this.get("subset")));return a.pop(),a}.property("subset")}),App.PwidgetController=Ember.Controller.extend({needs:["main"],client:Ember.computed.alias("controllers.main.client"),state:Ember.computed.alias("controllers.main.state"),child_data:void 0,loading:!1,profile_type_sig:!1,get_data:function(){var a=this,b=this.get("model.profile_field"),c=this.get("model.profile_type"),d=this.get("model.subset");b&&(this.set("loading",!0),a.set("model.data",void 0),this.get("client").run_fetch_profiler(b.field,c,d,this.get("state"),function(b){a.set("model.data",b),a.set("loading",!1)}))},profile_type_did_change:function(){this.get("profile_type_sig")?this.set("model.profile_type","sig"):this.set("model.profile_type","freq")}.observes("profile_type_sig"),select_form_type_field:function(){this.get_data()}.observes("model.profile_field.field","model.profile_type"),add_subset:function(a,b){var c=JSON.parse(JSON.stringify(this.get("model.subset")));return b&&c.pop(),a.field=this.get("model.profile_field"),c.push(a),c},actions:{select_item:function(a){var b;b=this.get("child_data")?this.add_subset(a,!0):this.add_subset(a,!1),this.set("child_data",App.PWidgetData.create({form_type_fields:this.get("model.form_type_fields"),subset:b,profile_field:void 0}))}}}),App.PwidgetView=Ember.View.extend({templateName:"pwidget"}),App.ReportView=Ember.View.extend({templateName:"report",didInsertElement:function(){try{var a=ace.edit("report-viewer");a.setTheme("ace/theme/monokai"),a.getSession().setMode("ace/mode/javascript"),this.set("controller.targetObject.report",a),console.log(" -- using JSON report viewer --")}catch(b){console.log(" -- using graphene report viewer --")}}}),App.Report=Ember.Object.extend({}),App.Report.reopenClass({grapheneReport:function(a,b,c){function d(a){var b=_.filter(a.id.split("_"),function(a){return""!==a})[0],c=config.GRAPHENE_REPORT_KEY[a.type],d=config.GRAPHENE_URL_BASE+c+"/"+b;return d}var e=d(b);a.set("report_url",e),"right"==c&&window.open(e,"_blank")},yamlReport:function(a,b,c){a.get("client").get_report(b.type,b.id,function(b){a.set("report_data",b);var c=a.get("report");console.log("report",c),c.getSession().setValue(JSON.stringify(b,null,"	"))})},clickHelper:function(a,b,c){config.GRAPHENE_URL_BASE?App.Report.grapheneReport(b,a,c):App.Report.yamlReport(b,a,c)},make_report_modal:function(a){var b=a.fetchers,c=a.controller,d=a.title,e=b[_.keys(b)[0]],f={reverse:!1,page:0,sortBy:"total_amount"};c.set("report_url",void 0),e(f,function(a){Ember.Widgets.ModalComponent.popup({primary:{classNames:["report-modal"],contentViewClass:App.ReportView,targetObject:c,headerText:d,confirmText:"Done",cancelText:void 0,fetchers:b,current_fetcher:_.keys(b)[0],fetcher_names:_.keys(b),data:a,sortBy:f.sortBy,reverse:f.reverse,page:f.page,show_page_down:a.min_showing>0,show_page_up:a.max_showing<a.total_count,use_graphene:config.GRAPHENE_URL_BASE||!1,onClick:function(a){App.Report.clickHelper(a,c,"left")},onRightClick:function(a){App.Report.clickHelper(a,c,"right")}},computed:{col_width:99,table_columns:function(){var a=this.get("col_width");return[Ember.Table.ColumnDefinition.create({defaultColumnWidth:9*a/6,textAlign:"text-align-left",headerCellName:"Report ID",headerCellViewClass:"App.ServerHeaderCell",contentPath:"id",can_sort:!0,getCellContent:function(a){return a.id}}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:5*a/6,textAlign:"text-align-left",headerCellName:"Report Type",headerCellViewClass:"App.ServerHeaderCell",contentPath:"type",can_sort:!0,getCellContent:function(a){return a.type.replace("type_","").toUpperCase()}}),Ember.Table.ColumnDefinition.create({defaultColumnWidth:5*a/6,textAlign:"text-align-left",headerCellName:"Date",headerCellViewClass:"App.ServerHeaderCell",contentPath:"date_filed",can_sort:!0})]}.property(),actions:{export_data:function(){var a=this;this.get("fetchers")[this.get("current_fetcher")]({sortBy:a.get("sortBy"),reverse:a.get("reverse"),page:0,n_reports:config.MAX_EXPORT_REPORTS},function(a){console.log("data report export",a);var b=_.keys(a.reports[0]),c=_.map(a.reports,function(a){return _.values(a).join(",")}).join("\n");App.Helper.download(b+"\n"+c,"reports_download_"+ +new Date+".csv","text/csv")})},fetch:function(a){var b=this;this.set("current_fetcher",a),this.get("fetchers")[a](function(a){b.set("data",a),b.set("show_page_down",a.min_showing>0),b.set("show_page_up",a.max_showing<a.total_count)})},paginate:function(a){var b=this,c=this.get("page");this.set("page",Math.max(c+a,0)),this.get("fetchers")[this.get("current_fetcher")]({sortBy:b.get("sortBy"),reverse:b.get("reverse"),page:b.get("page")},function(a){b.set("data",a),b.set("show_page_down",a.min_showing>0),b.set("show_page_up",a.max_showing<a.total_count)})}}}})})}}),App.FinancialTableHeaderCell=Ember.Table.HeaderCell.extend({templateName:"table_cells/financial-table-header-cell",sort_column:function(a,b){var c=a.get("controller.content"),d=a.get("controller.current_sorted_column"),e=b.contentIndex,f=JSON.parse(JSON.stringify(c));f.root.children=App.Helper.nested_sortBy(c.root.children,e),d==e?a.toggleProperty("controller.reverseSort"):a.set("controller.reverseSort",!0),a.get("controller.reverseSort")&&(f.root.children=App.Helper.nested_reverse(f.root.children,e)),a.set("controller.current_sorted_column",e),a.set("controller.content",[]),a.set("controller.content",f)},scale_column:function(a,b){console.log("scaling column",a,b)},click:function(a){if($headerView=$(a.target).parents(".ember-table-cell"),view=Ember.View.views[$headerView.attr("id")],view){var b=view.content.can_sort,c=view.content.can_scale;b?this.sort_column(this,view):c&&this.toggleProperty("controller.scale")}}}),App.FinancialTableTreeCell=Ember.Table.TableCell.extend({templateName:"table_cells/financial-table-tree-cell",classNames:"ember-table-table-tree-cell",paddingStyle:Ember.computed(function(){return"padding-left:"+this.get("row.indentation")+"px;"}).property("row.indentation"),rowNumber:Ember.computed(function(){return this.get("row.rowNumber")}).property("row.rowNumber")}),App.FinancialTableHeaderTreeCell=Ember.Table.HeaderCell.extend({templateName:"table_cells/financial-table-header-tree-cell",classNames:"ember-table-table-header-tree-cell"}),App.FinancialTableTreeTableRow=Ember.Table.Row.extend({content:null,children:null,parent:null,isRoot:!1,isLeaf:!1,isCollapsed:!1,isShowing:!0,indentationSpacing:20,groupName:null,rowNumber:0,computeStyles:function(a){var b,c,d,e,f,g;return b=0,d=0,e=!0,a&&(e=a.get("isShowing")&&!a.get("isCollapsed"),f=a.get("groupingLevel"),b=f,a.get("groupName")!==this.get("groupName")&&(b+=1),c=b===f?"half":"full",g=this.get("indentationSpacing"),a.get("isRoot")||(d=a.get("indentation"),d+="half"===c?g/2:g)),this.set("groupingLevel",b),this.set("indentation",d),this.set("isShowing",e)},computeRowStyle:function(a){var b;return b=this.getFormattingLevel(this.get("groupingLevel"),a),this.set("rowStyle","ember-table-row-style-"+b)},recursiveCollapse:function(a){return this.set("isCollapsed",a),this.get("children").forEach(function(b){return b.recursiveCollapse(a)})},getFormattingLevel:function(a,b){switch(b){case 1:return 5;case 2:return 1===a?2:5;case 3:return 1===a?1:2===a?3:5;case 4:return 1===a?1:2===a?2:4===a?4:5;case 5:return a;default:return a===b?5:Math.min(a,4)}}}),App.FinancialTableComponent=Ember.Table.EmberTableComponent.extend({numFixedColumns:1,isCollapsed:!1,isHeaderHeightResizable:!0,rowHeight:30,hasHeader:!0,hasFooter:!0,sortAscending:!1,sortColumn:null,selection:null,actions:{toggleTableCollapse:function(a){var b,c;return this.toggleProperty("isCollapsed"),c=this.get("isCollapsed"),b=this.get("root.children"),b&&b.get("length")>0?(b.forEach(function(a){return a.recursiveCollapse(c)}),this.notifyPropertyChange("rows")):void 0},toggleCollapse:function(a){return a.toggleProperty("isCollapsed"),Ember.run.next(this,function(){return this.notifyPropertyChange("rows")})}},content:null,columns:null,root:Ember.computed(function(){var a;return(a=this.get("content"))?this.createTree(null,a.root):void 0}).property("content","sortAscending","sortColumn"),rows:Ember.computed(function(){var a,b,c;return(b=this.get("root"))?(c=this.flattenTree(null,b,Ember.A()),this.computeStyles(null,b),a=Math.max.apply(c.getEach("groupingLevel")),c.forEach(function(b){return b.computeRowStyle(a)}),c):Ember.A()}).property("root","content"),bodyContent:Ember.computed(function(){var a;return(a=this.get("rows"))?(a=a.slice(1,a.get("length")),a.filterProperty("isShowing")):Ember.A()}).property("rows"),footerContent:Ember.computed(function(){var a;return a=this.get("rows"),a?a.slice(0,1):Ember.A()}).property("rows"),createTree:function(a,b,c){var d,e,f=this;if(e=App.FinancialTableTreeTableRow.create(),b){var g=0;return d=(b.children||[]).map(function(a){var b=f.createTree(e,a,g);return g+=1,b}),e.setProperties({isRoot:!a,isLeaf:Ember.isEmpty(d),content:b,parent:a,children:d,groupName:b.group_name,isCollapsed:a?a.isCollapsed:!1,rowNumber:c}),e}},flattenTree:function(a,b,c){var d=this;return c.pushObject(b),(b.children||[]).forEach(function(a){return d.flattenTree(b,a,c)}),c},computeStyles:function(a,b){var c=this;return b.computeStyles(a),b.get("children").forEach(function(a){return c.computeStyles(b,a)})}}),Number.prototype.toCurrency=function(){var a;return isNaN(this)||!isFinite(this)?"-":(a=Math.abs(this).toFixed(2),a=a.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),(0>this?"-$":"$")+a)},Number.prototype.toPercent=function(){return isNaN(this)||!isFinite(this)?"-":Math.abs(100*this).toFixed(2)+"%"};